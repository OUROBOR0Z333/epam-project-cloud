# Application Deployment Workflow - 2.9-deploy-application

## Overview

The `2.9-deploy-application.yml` GitHub Actions workflow is designed to deploy the movie-analyst application to your GCP infrastructure. This workflow follows the same authentication patterns and secret management as the other infrastructure workflows in the project.

## Purpose

This workflow performs application deployment to existing infrastructure and is positioned as step 2.9 in the sequential deployment process, which follows:

1. 2.1 - VPC creation
2. 2.2 - Subnet creation
3. 2.3 - NAT gateway creation
4. 2.4 - Firewall/security rules creation
5. 2.5 - Compute instances creation
6. 2.6 - Database creation
7. 2.7 - Load balancer creation
8. 2.8 - Application deployment (original)
9. **2.9 - Application deployment (enhanced) - current workflow**

## Key Features

### 1. Consistent Authentication
- Uses the same GCP authentication pattern as other workflows (GCP_SA_KEY secret)
- Follows the same Terraform workspace management approach
- Uses consistent environment variable patterns

### 2. Dynamic Infrastructure Discovery
- Retrieves infrastructure information using Terraform outputs
- Uses gcloud commands to get current resource details (IP addresses, instance names)
- Creates a dynamic Ansible inventory based on actual infrastructure state

### 3. Environment Support
- Supports both 'qa' and 'prod' environments
- Uses appropriate Terraform workspace for each environment
- Dynamically discovers infrastructure details per environment

### 4. Secure Credential Management
- Passes database credentials securely to Ansible without logging
- Uses temporary inventory files to avoid committing sensitive information
- Maintains SSH security through bastion host

## Authentication Order

The workflow follows this authentication and execution sequence:

1. **GitHub Actions Authentication**
   - Authenticates to GCP using `GCP_SA_KEY` secret
   - Sets up gcloud SDK with project ID

2. **Terraform Authentication**
   - Initializes Terraform with backend configuration
   - Selects appropriate workspace based on environment input
   - Retrieves infrastructure state

3. **Infrastructure Discovery**
   - Uses Terraform outputs to get database information
   - Uses gcloud commands to get instance IPs and details
   - Creates dynamic inventory for Ansible

4. **Application Deployment**
   - Executes Ansible playbook with discovered infrastructure details
   - Deploys application to appropriate hosts using bastion SSH tunneling

## Required Secrets

This workflow requires the same secrets as other infrastructure workflows:

- `GCP_PROJECT_ID` - Google Cloud Project ID
- `GCP_REGION` - Deployment region
- `GCP_ZONE` - Deployment zone
- `GCP_SA_KEY` - Service account key JSON
- `DB_ROOT_PASSWORD` - Database root password

## Integration with Other Workflows

This workflow can be run independently after infrastructure has been deployed, or as part of a complete deployment pipeline. It's designed to work with the infrastructure deployed by the sequential workflows (2.1 through 2.8).

## Running the Workflow

1. Go to the "Actions" tab in your GitHub repository
2. Select "2.9-deploy-application" from the workflow list
3. Click "Run workflow"
4. Select the environment (qa/prod) and click "Run workflow"

## Error Handling

- The workflow includes proper error handling for missing infrastructure
- Exits gracefully if required infrastructure components are not found
- Provides clear error messages for troubleshooting

## Security Considerations

- Database credentials are handled securely via Terraform outputs or secrets
- SSH connection established through bastion host maintains network security
- Temporary inventory files are created in the runner and not persisted
- Host key checking is disabled to accommodate dynamic infrastructure